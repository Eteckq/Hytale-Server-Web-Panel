services:
  hytale:
    build:
      context: .
      dockerfile: DockerfileHytale
      args:
        HYTALE_UID: ${HYTALE_UID:-9000}
        HYTALE_GID: ${HYTALE_GID:-9000}
    restart: on-failure:3
    labels:
      - "hytale.server=${IDENTIFIER:-hytale}"
    
    environment:
      # Java / RAM
      - JAVA_MIN_RAM=${JAVA_MIN_RAM:-3G}
      - JAVA_MAX_RAM=${JAVA_MAX_RAM:-4G}
      - HYTALE_PATCHLINE=${HYTALE_PATCHLINE:-release}
      # Server
      - TZ=${TZ:-Europe/Paris}
      # User permissions
      - HYTALE_UID=${HYTALE_UID:-9000}
      - HYTALE_GID=${HYTALE_GID:-9000}


    # Ports - UDP for game
    ports:
      - ${HYTALE_SEVER_PORT:-5520}:5520/udp
    
    # Volumes - Bind Mounts (HOST_DATA_PATH -> /opt/hytale im Container)
    volumes:
      - ${HOST_DATA_PATH:-/opt/hytale}/server:/opt/hytale/server
      - ${HOST_DATA_PATH:-/opt/hytale}/data:/opt/hytale/data
      - ${HOST_DATA_PATH:-/opt/hytale}/backups:/opt/hytale/backups
      - ${HOST_DATA_PATH:-/opt/hytale}/downloader:/opt/hytale/downloader

    # Console
    stdin_open: true
    tty: true

    # Network for manager communication
    networks:
      - internal-net

    # SECURITY: Resource limits to prevent resource exhaustion
    # Note: DOCKER_MEMORY_LIMIT should be >= JAVA_MAX_RAM + 1G for overhead
    deploy:
      resources:
        limits:
          cpus: '${DOCKER_CPU_LIMIT:-4}'
          memory: ${DOCKER_MEMORY_LIMIT:-8G}
        reservations:
          cpus: '1'
          memory: ${JAVA_MAX_RAM:-4G}

  # ============================================================
  # Hytale Server Manager - Web UI
  # ============================================================
  hytale-manager:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped

    environment:
      - PANEL_PASSWORD=${PANEL_PASSWORD:-changeme}
      - JWT_SECRET=${JWT_SECRET:-CHANGE_434_IT}
      
      - SERVER_PATH=/opt/hytale/server
      - BACKUPS_PATH=/opt/hytale/backups
      - DATA_PATH=/opt/hytale/data
      - DOWNLOADER_PATH=/opt/hytale/downloader
      - IDENTIFIER=${IDENTIFIER:-hytale}


    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

      - ${HOST_DATA_PATH:-/opt/hytale}/server:/opt/hytale/server
      - ${HOST_DATA_PATH:-/opt/hytale}/data:/opt/hytale/data
      - ${HOST_DATA_PATH:-/opt/hytale}/backups:/opt/hytale/backups
      - ${HOST_DATA_PATH:-/opt/hytale}/downloader:/opt/hytale/downloader

    ports:
      - 80
      
# ============================================================
# Networks
# ============================================================
networks:
  internal-net:
    name: ${IDENTIFIER:-hytale}-net
    driver: bridge

